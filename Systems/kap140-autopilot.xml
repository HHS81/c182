<?xml version="1.0"?>
<!-- KAP 140 Autopilot Configuration -->
<!-- Each component is evaluated in the order specified.  You can make up -->
<!-- property names to pass the result of one component on to a subsequent -->
<!-- component. -->


<PropertyList include="Aircraft/c182s/Models/Instruments/Avionics/kap140/kap140-config.xml">

	<filter>
        <name>heading bug backcourse</name>
        <debug>false</debug>
        <type>gain</type>
        <input>
            <condition>
                <less-than>
                    <property>autopilot/settings/heading-bug-deg</property>
                    <value>180</value>
                </less-than>
            </condition>
            <expression>
                <sum>
                    <property>autopilot/settings/heading-bug-deg</property>
                    <value>180</value>
                </sum>
            </expression>
        </input>
        <input>
            <expression>
                <sum>
                    <value>-180</value>
                    <property>autopilot/settings/heading-bug-deg</property>
                </sum>
            </expression>
        </input>
        <output>
            <property>autopilot/settings/heading-bug-deg-backcourse</property>
        </output>
    </filter>

	<filter>
		<name>heading bug error computer/normalizer</name>
		<debug>false</debug>
		<type>gain</type>

		<!-- REV mode -->
        <input>
            <condition>
                <less-than>
                    <property>autopilot/kap140/panel/hdg-timer</property>
                    <value>1</value>
                </less-than>
                <or>
                    <equals>
                        <property>/autopilot/kap140/settings/lateral-arm</property>
                        <value type="int">3</value>
                    </equals>
                    <equals>
                        <property>/autopilot/kap140/settings/lateral-mode</property>
                        <value type="int">5</value>
                    </equals>
                </or>
            </condition>
            <property>autopilot/settings/heading-bug-deg-backcourse</property>
            <offset>
                <property>instrumentation/heading-indicator/indicated-heading-deg</property>
                <scale>-1.0</scale>
            </offset>
        </input>

		<input>
			<property>autopilot/settings/heading-bug-deg</property>
			<offset>
				<property>instrumentation/heading-indicator/indicated-heading-deg</property>
				<scale>-1.0</scale>
			</offset>
		</input>
		<output>autopilot/internal/heading-bug-error-deg</output>
		<period>
			<min>-180</min>
			<max>180</max>
		</period>
		<gain>1.0</gain>
	</filter>

<!-- =============================================================== -->
<!-- Roll Axis Modes                                                 -->
<!-- =============================================================== -->

<!-- Nav hold (NAV) Mode -->
    <filter>
        <name>Nav hold (NAV) Mode</name>
        <debug>false</debug>
        <enable>
			<condition>
				<property>instrumentation/nav-source/in-range</property>
				<equals>
					<property>autopilot/kap140/settings/lateral-mode</property>
					<value>3</value>
				</equals>
				<less-than>
					<property>autopilot/kap140/panel/nav-timer</property>
					<value>1</value>
				</less-than>
			</condition>
		</enable>
        <type>gain</type>
        <input>
             <property>instrumentation/nav-source/heading-needle-deflection</property>
        </input>
        <output>
			<property>autopilot/internal/target-intercept-angle</property>
		</output>
            <min>-45</min>
            <max>45</max>
        <gain>-18</gain>
    </filter>

<!-- Approach hold (APR) Mode -->
    <filter>
        <name>Approach hold (APR) Mode</name>
        <debug>false</debug>
        <enable>
            <condition>
				<property>instrumentation/nav-source/in-range</property>
				<equals>
					<property>autopilot/kap140/settings/lateral-mode</property>
					<value>4</value>
				</equals>
				<less-than>
					<property>autopilot/kap140/panel/nav-timer</property>
					<value>1</value>
				</less-than>
			</condition>
        </enable>
        <type>gain</type>
        <input>
			<property>instrumentation/nav-source/heading-needle-deflection</property>
		</input>
        <output>
			<property>autopilot/internal/target-intercept-angle</property>
		</output>
            <min>-45</min>
            <max>45</max>
        <gain>-18</gain>
    </filter>

<!-- Backcourse hold (REV) Mode -->
    <filter>
        <name>Backcourse hold (REV) Mode</name>
        <debug>false</debug>
        <enable>
			<condition>
				<property>instrumentation/nav-source/in-range</property>
				<equals>
					<property>autopilot/kap140/settings/lateral-mode</property>
					<value>5</value>
				</equals>
				<less-than>
					<property>autopilot/kap140/panel/nav-timer</property>
					<value>1</value>
				</less-than>
			</condition>
		</enable>
        <type>gain</type>
        <input>
			<property>instrumentation/nav-source/heading-needle-deflection</property>
			<scale>1.0</scale>
		</input>
        <output>
			<property>autopilot/internal/target-intercept-angle</property>
		</output>
            <min>-45</min>
            <max>45</max>
        <gain>18</gain>
    </filter> 

<!-- Intercept Angle for HDG mode -->
	<filter>
		<name>target intercept angle</name>
		<debug>false</debug>
		<type>gain</type>
		<enable>
			<condition>
				<greater-than>
					<property>autopilot/kap140/settings/lateral-mode</property>
					<value>0</value>
				</greater-than>
				<less-than>
					<property>autopilot/kap140/settings/lateral-mode</property>
					<value>3</value>
				</less-than>
				<greater-than>
					<property>autopilot/kap140/settings/lateral-arm</property>
					<value>0</value>
				</greater-than>
			</condition>
		</enable>
        <input>
			<condition><!-- REV left side -->
                <equals>
					<property>autopilot/kap140/settings/lateral-arm</property>
					<value>3</value>
				</equals>
				<not><property>autopilot/kap140/config/hsi-installed</property></not>
				<less-than>
					<property>autopilot/kap140/panel/hdg-timer</property>
					<value>1</value>
				</less-than>
				<property>instrumentation/nav-source/in-range</property>
				<greater-than>
					<property>instrumentation/nav-source/heading-needle-deflection</property>
					<value>0.0</value>
				</greater-than>
			</condition>
			<value>45.0</value>
		</input>
        <input>
			<condition><!-- REV right side -->
                <equals>
					<property>autopilot/kap140/settings/lateral-arm</property>
					<value>3</value>
				</equals>
				<not><property>autopilot/kap140/config/hsi-installed</property></not>
				<less-than>
					<property>autopilot/kap140/panel/hdg-timer</property>
					<value>1</value>
				</less-than>
				<property>instrumentation/nav-source/in-range</property>
				<less-than>
					<property>instrumentation/nav-source/heading-needle-deflection</property>
					<value>0.0</value>
				</less-than>
			</condition>
			<value>-45.0</value>
		</input>
        
		<input>
            <condition> <!-- NAV/APR left side -->
				<equals>
					<property>autopilot/kap140/settings/lateral-mode</property>
					<value>2</value>
				</equals>
				<not><property>autopilot/kap140/config/hsi-installed</property></not>
				<less-than>
					<property>autopilot/kap140/panel/hdg-timer</property>
					<value>1</value>
				</less-than>
				<property>instrumentation/nav-source/in-range</property>
				<less-than>
					<property>instrumentation/nav-source/heading-needle-deflection</property>
					<value>0.0</value>
				</less-than>
			</condition>
			<value>45.0</value>
		</input>
		<input>
			<condition><!-- NAV/APR right side -->
				<equals>
					<property>autopilot/kap140/settings/lateral-mode</property>
					<value>2</value>
				</equals>
				<not><property>autopilot/kap140/config/hsi-installed</property></not>
				<less-than>
					<property>autopilot/kap140/panel/hdg-timer</property>
					<value>1</value>
				</less-than>
				<property>instrumentation/nav-source/in-range</property>
				<greater-than>
					<property>instrumentation/nav-source/heading-needle-deflection</property>
					<value>0.0</value>
				</greater-than>
			</condition>
			<value>-45.0</value>
		</input>
        <input>
			<value>0.0</value>
		</input>
		<output>
			<property>autopilot/internal/target-intercept-angle</property>
		</output>
	</filter>

<!-- Intercept Angle for ROL mode -->
	<filter>
		<name>target-turn-rate</name>
		<debug>false</debug>
		<type>gain</type>
		<enable>
			<condition>
				<or>
					<equals>
						<property>autopilot/kap140/settings/lateral-mode</property>
						<value>1</value>
					</equals>
					<and>
						<greater-than>
							<property>autopilot/kap140/settings/lateral-mode</property>
							<value>2</value>
						</greater-than>
						<greater-than>
							<property>autopilot/kap140/panel/nav-timer</property>
							<value>1</value>
						</greater-than>
					</and>
				</or>
			</condition>
		</enable>
		<input>
			<value>0.0</value>
		</input>
		<output>
			<property>autopilot/internal/target-turn-rate</property>
		</output>
	</filter>

<!-- Heading Select (HDG) Mode -->
    <filter>
        <name>Heading Select (HDG) Mode - tgt turn angle</name>
        <debug>false</debug>
        <enable>
            <condition>
				<or>
					<equals>
						<property>autopilot/kap140/settings/lateral-mode</property>
						<value>2</value>
					</equals>
					<and>
						<greater-than>
							<property>autopilot/kap140/settings/lateral-mode</property>
							<value>2</value>
						</greater-than>
						<less-than>
							<property>autopilot/kap140/panel/nav-timer</property>
							<value>1</value>
						</less-than>
					</and>
				</or>
			</condition>
        </enable>
        <type>gain</type>
        <input>
            <expression>
                <difference>
                    <property>autopilot/internal/target-intercept-angle</property>
                    <property>autopilot/internal/heading-bug-error-deg</property>
                </difference>
            </expression>
        </input>
        <output>
            <property>autopilot/internal/target-turn-rate</property>
        </output>
        <gain>-0.045</gain>
        <min>-1</min>
        <max>1</max>
    </filter>


<!-- Actually this maintains the attitude indicator to a target roll rate.
         With ROL its always zero, but with HDG its the computed turn rate to reach the hdg-bugs heading -->
  <pi-simple-controller>
        <name>Wing Leveler (ROL) Mode</name>
        <debug>false</debug>
        <enable>
            <condition>
                <greater-than>
                    <property>autopilot/kap140/settings/lateral-mode</property>
                    <value>0</value>
                </greater-than>
            </condition>
        </enable>
        <input>
            <property>/instrumentation/turn-indicator/indicated-turn-rate</property>
        </input>
        <reference>
            <property>autopilot/internal/target-turn-rate</property>
        </reference>
        <output>
            <property>autopilot/kap140/servo/aileron</property>
        </output>
        <config>
            <Kp>0.25</Kp>          <!-- proportional gain -->
            <Ki>0.010 </Ki>        <!-- integral gain -->
            <u_min>-0.25</u_min>   <!-- minimum output clamp -->
            <u_max>0.25</u_max>    <!-- maximum output clamp -->
        </config>
  </pi-simple-controller>


<!-- =============================================================== -->
<!-- Pitch Axis Modes                                                -->
<!-- =============================================================== -->

<!-- Altitude Capture (ALT ARM) -->
	<filter>
		<name>slow down FPM while approaching ALT</name>
		<debug>false</debug>
		<type>gain</type>
		<enable>
			<condition>
				<equals>
					<property>autopilot/kap140/settings/vertical-arm</property>
					<value>1</value>
				</equals>
				<greater-than>
					<expression>
						<product>
							<abs>
								<property>autopilot/internal/vert-speed-fpm</property>
							</abs>
							<value>0.1</value>
						</product>
					</expression>
					<expression>
						<abs>
							<dif>
								<property>autopilot/internal/target-altitude</property>
								<property alias="../../../../../../../../params/indicated-altitude-ft" />
							</dif>
						</abs>
					</expression>
				</greater-than>
			</condition>
		</enable>
		<input>
			<condition>
				<less-than>
					<property alias="../../../../../params/indicated-altitude-ft" />
					<property>autopilot/internal/target-altitude</property>
				</less-than>
			</condition>
			<expression>
				<product>
					<ceil>
						<product>
							<dif>
								<property>autopilot/internal/target-altitude</property>
								<property alias="../../../../../../../../params/indicated-altitude-ft" />
							</dif>
							<value>0.1</value>
						</product>
					</ceil>
					<value>100</value>
				</product>
			</expression>
		</input>
		<input>
			<expression>
				<product>
					<floor>
						<product>
							<dif>
								<property>autopilot/internal/target-altitude</property>
								<property alias="../../../../../../../../params/indicated-altitude-ft" />
							</dif>
							<value>0.1</value>
						</product>
					</floor>
					<value>100</value>
				</product>
			</expression>
		</input>
		<output>autopilot/internal/target-climb-rate</output>
	</filter>


    <!-- Vertical Speed (VS) Mode -->
    <filter>
        <name>Vertical Speed (VS) Mode</name>
        <debug>false</debug>
        <enable>
            <condition>
                <or>
                    <and>
                        <equals>
                            <property>autopilot/kap140/settings/vertical-mode</property>
                            <value>1</value>
                        </equals>
                        <equals>
                            <property>autopilot/kap140/panel/button-up</property>
                            <value>0</value>
                        </equals>
                        <equals>
                            <property>autopilot/kap140/panel/button-down</property>
                            <value>0</value>
                        </equals>
                    </and>
                    <and>
                        <!-- ALT-HOLD adjustment by holding UP/DN buttons -->
                        <equals>
                            <property>autopilot/kap140/settings/vertical-mode</property>
                            <value>2</value>
                        </equals>
                        <or>
                            <greater-than>
                                <property>sim/time/elapsed-sec</property>
                                <expression>
                                    <sum>
                                        <property>autopilot/kap140/panel/button-up</property>
                                        <value>1</value>
                                    </sum>
                                </expression>
                            </greater-than>
                            <greater-than>
                                <property>sim/time/elapsed-sec</property>
                                <expression>
                                    <sum>
                                        <property>autopilot/kap140/panel/button-down</property>
                                        <value>1</value>
                                    </sum>
                                </expression>
                            </greater-than>
                        </or>
                    </and>
                </or>
            </condition>
        </enable>
        <type>gain</type>
        <input>
            <expression>
                <div>
                    <product>
                        <value>-1</value>
                        <product>
                            <floor>
                                <sum>
                                    <div>
                                        <property>autopilot/internal/target-climb-rate</property>
                                        <value>100</value>
                                    </div>
                                    <value>0.5</value>
                                </sum>
                            </floor>
                            <value>100</value>
                        </product>
                    </product>

                    <value>58000</value>
                </div>
            </expression>
        </input>
        <output>
            <property>autopilot/internal/target-pressure-rate</property>
        </output>
    </filter>

    
    <!-- Altitude Hold (ALT) Mode -->
    <pid-controller>
        <name>Altitude Hold (ALT) Mode</name>
        <debug>false</debug>
        <enable>
			<condition>
				<equals>
					<property>autopilot/kap140/settings/vertical-mode</property>
					<value>2</value>
				</equals>
				<equals>
					<property>autopilot/kap140/panel/button-up</property>
					<value>0</value>
				</equals>
				<equals>
					<property>autopilot/kap140/panel/button-down</property>
					<value>0</value>
				</equals>
			</condition>
		</enable>
        <input>
            <!--<property>/systems/static[1]/pressure-inhg</property>-->
            <property>/systems/static[1]/pressure-inhg-venturi</property> <!-- use internal cockpit pressure port with venturi effect applied -->
        </input>
        <reference>
            <property>/autopilot/internal/target-pressure</property>
        </reference>
        <output>
            <property>/autopilot/internal/target-pressure-rate</property>
        </output>
        <config>
            <Kp>0.125</Kp> <!-- proportional gain -->
            <beta>1.0</beta> <!-- input value weighing factor -->
            <alpha>0.1</alpha> <!-- low pass filter weighing factor -->
            <gamma>0.0</gamma> <!-- input value weighing factor for -->
            <!-- unfiltered derivative error -->
            <Ti>12.0</Ti> <!-- integrator time -->
            <Td>0.0</Td> <!-- derivator time -->
            <u_min>-0.007</u_min> <!-- minimum output clamp -->
            <u_max>0.007</u_max> <!-- maximum output clamp -->
        </config>
    </pid-controller>

    <!-- Glideslope Hold (GS) Mode -->
    <pid-controller>
        <name>Glideslope Hold (GS) Mode</name>
        <debug>false</debug>
        <enable>
            <condition>
                <equals>
                    <property>autopilot/kap140/settings/vertical-mode</property>
                    <value>3</value>
                </equals>
                <property>instrumentation/nav-source/in-range</property>
                <property>instrumentation/nav-source/nav-loc</property>
                <property>instrumentation/nav-source/gs-in-range</property>
            </condition>
        </enable>
        <input>
            <property>/instrumentation/nav/gs-needle-deflection-norm</property>
        </input>
        <reference>
            <value>0.0</value>
        </reference>
        <output>
            <property>/autopilot/internal/target-pressure-rate</property>
        </output>
        <config>
            <Kp>0.025</Kp> <!-- proportional gain -->
            <beta>1.0</beta> <!-- input value weighing factor -->
            <alpha>0.1</alpha> <!-- low pass filter weighing factor -->
            <gamma>0.0</gamma> <!-- input value weighing factor for -->
            <!-- unfiltered derivative error -->
            <Ti>15.0</Ti> <!-- integrator time -->
            <Td>0.0</Td> <!-- derivator time -->
            <u_min>-0.001</u_min> <!-- minimum output clamp -->
            <u_max>0.017</u_max> <!-- maximum output clamp -->
        </config>
    </pid-controller>


    <filter>
        <name>KAP140 internal static port pressure rate computer</name>
        <debug>false</debug>
        <type>derivative</type>
        <input>
            <!--<property>/systems/static-pressure-inhg-selected</property>-->
            <property>/systems/static[1]/pressure-inhg-venturi</property> <!-- use cockpit pressure source with venturi effect applied -->
        </input>
        <output>
            <property>autopilot/internal/pressure-rate</property>
        </output>
        <filter-time>1.0</filter-time>
    </filter>

    <filter>
        <name>pressure-rate-filter</name>
        <debug>false</debug>
        <type>double-exponential</type>
        <input>
            <property>/autopilot/internal/pressure-rate</property>
        </input>
        <output>
            <property>/autopilot/internal/filtered-pressure-rate</property>
        </output>
        <filter-time>0.1</filter-time>
    </filter>


    <!-- VS PID controller controls the climb/descend rate in pressure change terms -->
    <!-- This is used from the VS, ALT and GS modes, which calculate the target pressure change rate -->
    <pid-controller>
        <name>Vertical Speed PID-Controller</name>
        <debug>false</debug>
        <enable>
            <condition>
                <greater-than>
                    <property>autopilot/kap140/settings/vertical-mode</property>
                    <value>0</value>
                </greater-than>
            </condition>
        </enable>
        <input>
            <property>/autopilot/internal/filtered-pressure-rate</property>
        </input>
        <reference>
            <property>autopilot/internal/target-pressure-rate</property>
        </reference>
        <output>
            <property>autopilot/kap140/servo/elevator</property>
        </output>
        <config>
            <Kp>5.0</Kp> <!-- proportional gain -->
            <beta>1.0</beta> <!-- input value weighing factor -->
            <alpha>0.1</alpha> <!-- low pass filter weighing factor -->
            <gamma>0.0</gamma> <!-- input value weighing factor for -->
            <!-- unfiltered derivative error -->
            <Ti>4.0</Ti> <!-- integrator time -->
            <Td>0.0</Td> <!-- derivator time -->
            <u_min>-0.5</u_min> <!-- minimum output clamp -->
            <u_max>0.5</u_max> <!-- maximum output clamp -->
        </config>
    </pid-controller>
    
<!--
    ===============================================================
    Servos
    ===============================================================
-->

	<filter>
		<name>roll-servo change rate</name>
		<debug>false</debug>
		<type>gain</type>
		<input>
			<condition>
				<equals>
					<property>autopilot/kap140/panel/state</property>
					<value>6</value>
				</equals>
				<not><property>autopilot/kap140/roll-axis-fail</property></not>
				<not><property>autopilot/kap140/settings/cws</property></not>
			</condition>
			<value>0.085</value>
		</input>
		<input>100.0</input>
		<output>autopilot/kap140/servo/aileron-rate</output>
	</filter>

	<filter>
		<name>roll-servo</name>
		<debug>false</debug>
		<type>noise-spike</type>
		<max-rate-of-change>
			<property>autopilot/kap140/servo/aileron-rate</property>
		</max-rate-of-change>
		<input>
			<condition>
				<equals>
					<property>autopilot/kap140/panel/state</property>
					<value>6</value>
				</equals>
				<not><property>autopilot/kap140/roll-axis-fail</property></not>
				<not><property>autopilot/kap140/settings/cws</property></not>
			</condition>
			<property>autopilot/kap140/servo/aileron</property>
		</input>
		<input>controls/flight/aileron</input>
		<output>controls/flight/aileron</output>
	</filter>

	<filter>
		<name>pitch-servo change rate</name>
		<debug>false</debug>
		<type>gain</type>
		<input>
			<condition>
				<equals>
					<property>autopilot/kap140/panel/state</property>
					<value>6</value>
				</equals>
				<not><property>autopilot/kap140/pitch-axis-fail</property></not>
				<not><property>autopilot/kap140/settings/cws</property></not>
			</condition>
			<value>0.0769</value>
		</input>
		<input>100.0</input>
		<output>autopilot/kap140/servo/elevator-rate</output>
	</filter>

	<filter>
		<name>pitch-servo</name>
		<debug>false</debug>
		<type>noise-spike</type>
		<max-rate-of-change>
			<property>autopilot/kap140/servo/elevator-rate</property>
		</max-rate-of-change>
		<input>
			<condition>
				<greater-than>
					<property>autopilot/kap140/config/model</property>
					<value>1</value>
				</greater-than>
				<equals>
					<property>autopilot/kap140/panel/state</property>
					<value>6</value>
				</equals>
				<not><property>autopilot/kap140/pitch-axis-fail</property></not>
				<not><property>autopilot/kap140/settings/cws</property></not>
			</condition>
			<property>autopilot/kap140/servo/elevator</property>
		</input>
		<input>controls/flight/elevator</input>
		<output>controls/flight/elevator</output>
	</filter>

    <filter>
        <name>vertical speed fpm</name>
        <debug>false</debug>
        <type>gain</type>
        <input>instrumentation/vertical-speed-indicator/indicated-speed-fpm</input>
        <output>autopilot/internal/vert-speed-fpm</output>
    </filter>

  <!-- Elevator-trim servo -->
  <!-- The pitch trimming aims to center the yoke, as to release pressure from it (autotrim) -->
    <filter>
        <name>elevator-trim demand value</name>
        <debug>false</debug>
        <enable>
            <condition>
                <greater-than>
                    <property>autopilot/kap140/config/model</property>
                    <value>1</value>
                </greater-than>
                <equals>
                    <property>autopilot/kap140/panel/state</property>
                    <value>6</value>
                </equals>
                <greater-than>
                    <property>autopilot/kap140/settings/vertical-mode</property>
                    <value>0</value>
                </greater-than>
            </condition>
        </enable>
        <type>gain</type>
        <input>
            <!-- when to-trim difference is too big: create big trim demand
                 (this causes the trim wheel to move until clamped or demand lowered) -->
            <condition>
                <or>
                    <greater-than>
                        <property>controls/flight/elevator</property>
                        <value>0.15</value>
                    </greater-than>
                    <less-than>
                        <property>controls/flight/elevator</property>
                        <value>-0.15</value>
                    </less-than>
                </or>
            </condition>
            <expression>
                <product>
                    <property>controls/flight/elevator</property>
                    <value>-100</value>
                </product>
            </expression>
        </input>
        <input>
            <!-- calculate normal trim demand -->
            <expression>
                <difference>
                    <value>0</value>
                    <property>controls/flight/elevator</property>
                </difference>
            </expression>
        </input>
        <output>
            <property>autopilot/kap140/servo/target-elevator-trim</property>
        </output>
        <gain>-1.0</gain>
        <min>-1.0</min>
        <max>1.0</max>
    </filter>

    <filter>
        <name>elevator-trim-servo change rate</name>
        <debug>false</debug>
        <type>gain</type>
        <input>
            <condition>
                <equals>
                    <property>autopilot/kap140/panel/state</property>
                    <value>6</value>
                </equals>
                <not><property>autopilot/kap140/pitch-axis-fail</property></not>
                <not><property>autopilot/kap140/settings/cws</property></not>
            </condition>
            <value>0.050</value> <!-- ~20s for 0-1; ie 40s for -1->0->1; https://assets.publishing.service.gov.uk/media/5422ec04e5274a13170000d5/dft_avsafety_pdf_501522.pdf -->
        </input>
        <input>120.0</input>
        <output>autopilot/kap140/servo/elevator-trim-rate</output>
    </filter>

    <filter>
        <name>elevator-trim-servo</name>
        <debug>false</debug>
        <type>noise-spike</type>
        <max-rate-of-change>
            <property>autopilot/kap140/servo/elevator-trim-rate</property>
        </max-rate-of-change>
        <input>
            <condition>
                <property>autopilot/kap140/config/autotrim-pitch</property>
                <greater-than>
                    <property>autopilot/kap140/config/model</property>
                    <value>1</value>
                </greater-than>
                <equals>
                    <property>autopilot/kap140/panel/state</property>
                    <value>6</value>
                </equals>
                <not><property>autopilot/kap140/pitch-axis-fail</property></not>
                <not><property>autopilot/kap140/settings/cws</property></not>
            </condition>
            <property>autopilot/kap140/servo/target-elevator-trim</property>
        </input>

        <!-- normal/manual operation:
             use the input value; but if really close to 0 snap to 0 (to allow reset of uneven values from the AP -->
        <input>
            <condition>
                <and>
                    <less-than>
                        <property>controls/flight/elevator-trim</property>
                        <value>0.01</value>
                    </less-than>
                    <greater-than>
                        <property>controls/flight/elevator-trim</property>
                        <value>-0.01</value>
                    </greater-than>
                </and>
            </condition>
            <value>0.00</value>
        </input>
        <input>controls/flight/elevator-trim</input>
        <output>controls/flight/elevator-trim</output>
    </filter>
</PropertyList>
